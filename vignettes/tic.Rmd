---
title: "Getting started with CI for R"
author: "Patrick Schratz, Kirill Müller"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Kirill Müller}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Prerequisites

If you are unfamiliar with the term Continuous Integration (CI), we highly recommend to read the following resources:

- https://ropensci.github.io/dev_guide/ci.html
- https://juliasilge.com/blog/beginners-guide-to-travis/
- http://mahugh.com/2016/09/02/travis-ci-for-test-automation/

The advantages of using `tic` for R-related CI workflows are: 

- CI-agnostic workflow definitions (in R!)
- Simplified deployment (e.g. automatic deployment of a `pkgdown` site for a R package)
- Improved package checking via [rcmdcheck](https://github.com/r-lib/rcmdcheck)
- Robust caching approach

A more comprehensive summary of all advantages can be found in the [advantages](advantages.html) vignette.

# Initialization

The easiest way to use `tic` for CI services is to call `usethis::use_ci()`.
This will create templates for both "Travis CI" and "Appveyor" and initialize all the required authentication steps for deployment.
During the process, browser pages will open app ensuring that all permissions are set correctly and all apps are authorized.
Also a Personal Access Token (PAT) will be created for Travis, using a private Github PAT variable.
Read [here](https://itsalocke.com/blog/using-travis-make-sure-you-use-a-github-pat/) why this is important.
Note that this procedure cannot be fully automated currently.

[ADD CODE OUTPUT OF use_ci()]

The functionality is integrated in the [`usethis`](http://usethis.r-lib.org/) package because it contains various other useful `use_*` functions that simplify R (package) development.
However, the heavy lifting in the background is actually done by the R packages `travis` and `tic`. 
See [here](tic-usethis-travis.html) for more detailed information on how `tic`, `travis` and `usethis` work together.

# Explanation of the basic template

After having called `usethis::use_ci()` you will find a `.travis.yml`, `appveyor.yml` and a `tic.R` file in your repo.
Usually you do not need to touch `appveyor.yml` and `.travis.yml` anymore.
All build customizations are done in `tic.R` and apply to both services.
If you want more information about the whole build lifecycle, check the [Build lifecycle](build-lifecycle.html) vignette.

The basic `tic.R` template looks as follows:

```r
add_package_checks(warnings_are_errors = (getRversion() >= "3.2"))

if (Sys.getenv("BUILD_PKGDOWN") != "") {
  get_stage("before_deploy") %>%
    add_step(step_setup_ssh())

  get_stage("deploy") %>%
    add_step(step_push_deploy()) %>% 
    add_step(step_build_pkgdown())
}
```

Let's break done what happens here:

```r
add_package_checks(warnings_are_errors = (getRversion() >= "3.2"))
```

Is a convenient function which adds essential steps to various stages of a CI run. For example, it adds `utils::update_packages(ask = FALSE)` to the "before_install" stage. Check `?add_package_checks()` to see a list of all added steps by this wrapper function.

```r
if (Sys.getenv("BUILD_PKGDOWN") != "") { }
```

This line conditions its contents on the existence of the environment variable `"BUILD_PKGDOWN"`.
The env variable is set in [`.travis.yml`](https://github.com/ropenscilabs/tic/blob/d3c9ffab7e42ef4bf0a3113337c42dbaf592146c/.travis.yml#L45-L47), conditioned on the job that runs on the current R-release version:

```yml
- r: release
env:
 - BUILD_PKGDOWN=true
```

If the if-condition evaluates to `TRUE`, the following is executed.
Function `step_setup_ssh()`  sets up the SSH connection needed for deployment.

```r
get_stage("before_deploy") %>%
  add_step(step_setup_ssh())
```

Then, in the "deploy" stage of the CI run, function `step_build_pkgdown()` will build a [`pkgdown`](http://pkgdown.r-lib.org/) site if the project is an R package.

```r
get_stage("deploy") %>%
  add_step(step_build_pkgdown())
```

# Examples projects

`tic` can be used for various R projects (see below). 

- [tic.blogdown](https://github.com/krlmlr/tic.blogdown)
- [ŧic.bookdown](https://github.com/krlmlr/tic.bookdown)
- [tic.drat](https://github.com/krlmlr/tic.drat)
- [tic.package](https://github.com/krlmlr/tic.package)
- [tic.website](https://github.com/krlmlr/tic.website)
- [tic.figshare](https://github.com/krlmlr/tic.figshare).

As an example, we explain a "blogdown" project in more detail.
[`blogdown`](https://bookdown.org/yihui/blogdown/) is a R package for publishing websites.
Under the hood, it uses the framework [HUGO](https://gohugo.io/) which gets installed by the respective `tic.R` [template](https://github.com/krlmlr/tic.blogdown/blob/975aedd43fec1dd55e8348eccfca2c7c5f663006/tic.R#L5) in the "install" section:

```r
get_stage("install") %>%
  add_code_step(blogdown::install_hugo(), prepare_call = remotes::install_github("rstudio/blogdown"))
```

Then the website is build and deployed.
The `blogdown::build_site()` function for websites is the equivalent to `pkgdown::build_site()` for R packages.

```r
get_stage("deploy") %>%
    add_code_step(blogdown::build_site()) %>%
    add_step(step_push_deploy())
```

You see, steps and stages differ between projects (here between a "blogdown" website and a "package").
`tic` is smart enough to detect your project automatically when calling `usethis::use_ci()` and will add the correct template.

**Note:** Currently, publishing to https://figshare.com/ doesn't work.
Also, publishing to https://zenodo.org/ is work in progress.

# Advanced

The advanced usage of `tic` is described in more detail in article [Advanced Usage](advanced.html):

- [Options for `pkgdown` deployment](advanced.html#pkgdown-deployment) 
- [Using Travis CI Meta-information](advanced.html#using-travis-ci-meta-information)
- [Troubleshooting: Running `tic` locally](advanced.html#troubleshooting-running-tic-locally)
- [Troubleshooting: Enter into the Travis build](advanced.html#troubleshooting-running-tic-locally)
- [Writing custom steps](custom-steps.html)

The build lifecycle when using `tic` is explained in detail [here](build-lifecycle.html).
